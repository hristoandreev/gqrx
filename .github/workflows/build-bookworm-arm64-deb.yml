name: Build gqrx (Qt6) .deb for Raspberry Pi OS (bookworm, arm64)

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-deb:
    runs-on: ubuntu-24.04-arm
    container: debian:bookworm

    env:
      SUITE: bookworm
      ARCH: arm64
      # Име на deb пакета (препоръчвам да НЕ е "gqrx", за да не се бие с официалния)
      PKGNAME: gqrx
      DEBIAN_FRONTEND: noninteractive
      DEB_BUILD_OPTIONS: nocheck
      DEBFULLNAME: gqrx
      DEBEMAIL: noreply@github.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build deps (Qt6 + GNU Radio + packaging)
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates git \
            build-essential pkg-config \
            cmake ninja-build \
            debhelper devscripts dpkg-dev fakeroot \
            qt6-base-dev qt6-base-dev-tools qt6-svg-dev \
            gnuradio-dev \
            libvolk2-dev \
            libpulse-dev \
            python3-six \
            gr-osmosdr

      - name: Build ana install SoapySDR
        run: |
          git clone https://github.com/pothosware/SoapySDR.git
          cd SoapySDR
          git pull origin master
          mkdir build
          cd build
          cmake ..
          make -j`nproc`
          make install -j`nproc`
          ldconfig #needed on debian systems
          SoapySDRUtil --info

      #- name: Build ana install gr-osmosdr
      #  run: |
      #    git clone https://gitea.osmocom.org/sdr/gr-osmosdr
      #    cd gr-osmosdr/
      #    mkdir build
      #    cd build/
      #    cmake ../
      #    make -j`nproc`
      #    make install -j`nproc`
      #    ldconfig

      - name: Compute CI version (POSIX-safe)
        run: |
          SHORT_SHA="$(printf '%s' "$GITHUB_SHA" | cut -c1-7)"
          VERSION="$(date -u +%Y%m%d%H%M)-g${SHORT_SHA}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "CI Version: $VERSION"

      - name: Generate minimal debian/ packaging (if missing) with Qt6 forced
        run: |
          set -e
          if [ -d debian ] && [ -f debian/control ]; then
            echo "Found existing debian/ packaging. Will use it."
            exit 0
          fi

          echo "No debian/ packaging found -> generating minimal debian/ (Qt6 forced)."
          mkdir -p debian/source

          cat > debian/control <<EOF
          Source: ${PKGNAME}
          Section: hamradio
          Priority: optional
          Maintainer: ${DEBFULLNAME} <${DEBEMAIL}>
          Build-Depends:
           debhelper-compat (= 13),
           cmake,
           ninja-build,
           pkg-config,
           qt6-base-dev,
           qt6-svg-dev,
           gnuradio-dev,
           libvolk2-dev,
           libpulse-dev
          Standards-Version: 4.6.2
          Rules-Requires-Root: no

          Package: ${PKGNAME}
          Architecture: ${ARCH}
          Depends: \${shlibs:Depends}, \${misc:Depends}
          Description: gqrx built with Qt6 (arm64, bookworm)
           Custom build of gqrx with Qt6 for Raspberry Pi OS (Bookworm).
          EOF

          cat > debian/rules <<'EOF'
          #!/usr/bin/make -f

          %:
          	dh $@ --buildsystem=cmake+ninja

          override_dh_auto_configure:
          	dh_auto_configure -- \
          	  -DCMAKE_BUILD_TYPE=Release \
          	  -DCMAKE_INSTALL_PREFIX=/usr \
          	  -DFORCE_QT6=ON \
          	  -DFORCE_QT5=OFF \
          	  -DLINUX_AUDIO_BACKEND=Pulseaudio
          EOF
          chmod +x debian/rules

          echo "3.0 (native)" > debian/source/format

          cat > debian/changelog <<EOF
          ${PKGNAME} (0.0.0) ${SUITE}; urgency=medium

            * Initial CI package.

           -- ${DEBFULLNAME} <${DEBEMAIL}>  $(date -u -R)
          EOF

      - name: Set debian/changelog version (CI)
        run: |
          dch --distribution "$SUITE" --newversion "$VERSION" "CI build" || true
          head -n 5 debian/changelog

      - name: Build .deb
        run: |
          set -e
          dpkg-buildpackage -b -us -uc -j"$(nproc)"
          mkdir -p dist
          # .deb излиза една директория нагоре
          cp -v ../${PKGNAME}_*_${ARCH}.deb dist/
          ls -la dist

      - name: Upload artifact (.deb)
        uses: actions/upload-artifact@v4
        with:
          name: deb-${{ env.PKGNAME }}-${{ env.VERSION }}
          path: dist/*.deb

      - name: Create GitHub Release (tags only)
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          files: dist/*.deb

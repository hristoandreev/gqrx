name: Build gqrx (Qt6) .deb (bookworm, arm64) -> artifact bookworm/...

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-24.04-arm
    container: debian:bookworm

    env:
      SUITE: bookworm
      ARCH: arm64
      PKGNAME: gqrx-wolfberry

      DEBIAN_FRONTEND: noninteractive
      DEB_BUILD_OPTIONS: nocheck
      DEBFULLNAME: gqrx-wolfberry
      DEBEMAIL: hristoandreev@wolfberry.lz1haa.eu

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build deps (Qt6 + GNU Radio + SoapySDR from APT + packaging)
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates git \
            curl jq python3 \
            build-essential pkg-config \
            cmake ninja-build \
            debhelper devscripts dpkg-dev fakeroot \
            qt6-base-dev qt6-base-dev-tools qt6-svg-dev \
            libxkbcommon-dev \
            gnuradio-dev gr-osmosdr \
            libsoapysdr-dev soapysdr-tools soapysdr-module-all \
            libvolk2-dev libpulse-dev

      - name: Compute DEB version (monotonic)
        run: |
          set -e
          SHORT_SHA="$(printf '%s' "$GITHUB_SHA" | cut -c1-7)"
          # валидна deb версия: започва с цифра + suite суфикс
          DEBVER="$(date -u +%Y%m%d%H%M)-g${SHORT_SHA}~${SUITE}1"
          echo "DEBVER=$DEBVER" >> "$GITHUB_ENV"
          echo "DEBVER=$DEBVER"

      - name: Ensure minimal debian/ packaging exists (Qt6 forced)
        run: |
          set -e
          if [ -d debian ] && [ -f debian/control ] && [ -f debian/rules ]; then
            echo "Found existing debian/ packaging."
            exit 0
          fi
          
          echo "Generating minimal debian/ packaging..."
          mkdir -p debian/source

          cat > debian/control <<EOF
          Source: ${PKGNAME}
          Section: hamradio
          Priority: optional
          Maintainer: ${DEBFULLNAME} <${DEBEMAIL}>
          Build-Depends:
           debhelper-compat (= 13),
           cmake,
           ninja-build,
           pkg-config,
           qt6-base-dev,
           qt6-svg-dev,
           libxkbcommon-dev,
           gnuradio-dev,
           gr-osmosdr,
           libsoapysdr-dev,
           libvolk2-dev,
           libpulse-dev
          Standards-Version: 4.6.2
          Rules-Requires-Root: no

          Package: ${PKGNAME}
          Architecture: ${ARCH}
          Depends: \${shlibs:Depends}, \${misc:Depends}
          Description: gqrx built with Qt6 (arm64, bookworm)
           Custom build of gqrx with Qt6 for Raspberry Pi OS (Bookworm).
          EOF

          cat > debian/rules <<'EOF'
          #!/usr/bin/make -f

          %:
          	dh $@ --buildsystem=cmake+ninja

          override_dh_auto_configure:
          	dh_auto_configure -- \
          	  -DCMAKE_BUILD_TYPE=Release \
          	  -DCMAKE_INSTALL_PREFIX=/usr \
          	  -DFORCE_QT6=ON \
          	  -DFORCE_QT5=OFF \
          	  -DLINUX_AUDIO_BACKEND=Pulseaudio
          EOF
          chmod +x debian/rules

          echo "3.0 (native)" > debian/source/format
          
      - name: Create/Update debian/changelog (always valid)
        run: |
          set -e
          if [ ! -f debian/changelog ]; then
            dch --create \
              --package "$PKGNAME" \
              --newversion "0.0.0" \
              --distribution "$SUITE" \
              "Initial CI package"
          fi
          dch --distribution "$SUITE" --newversion "$DEBVER" "CI build"
          head -n 5 debian/changelog

      - name: Build .deb
        run: |
          set -e
          dpkg-buildpackage -b -us -uc -j"$(nproc)"
          mkdir -p out
          cp -v ../${PKGNAME}_*_${ARCH}.deb out/
          ls -la out
          
      - name: Inspect produced .deb
        shell: bash
        run: |
          set -euo pipefail
          echo "=== out directory ==="
          ls -lah out || true

          DEB="$(ls -1 out/*.deb | head -n1)"
          echo "DEB: $DEB"

          echo "=== dpkg-deb -I (metadata) ==="
          dpkg-deb -I "$DEB" | sed -n '1,200p'

          echo "=== dpkg-deb -c (file list, first 200) ==="
          dpkg-deb -c "$DEB" | sed -n '1,200p'

          echo "=== check for /usr/bin/gqrx ==="
          dpkg-deb -c "$DEB" | awk '{print $6}' | grep -E '^\.?/usr/bin/gqrx$' || \
            echo "WARN: /usr/bin/gqrx not found in package!"

      - name: Show changelog header + rules (tabs)
        shell: bash
        run: |
          set -euo pipefail
          echo "=== debian/changelog head ==="
          head -n 15 debian/changelog || true

          echo "=== debian/rules (tabs show as ^I) ==="
          sed -n '1,80p' debian/rules | cat -A

      - name: Prepare artifact payload as "bookworm/<deb>.deb"
        run: |
          set -e
          rm -rf "${SUITE}"
          mkdir -p "${SUITE}"
          cp -v out/*.deb "${SUITE}/"
          ls -la "${SUITE}"

      - name: Upload artifact (apt-bookworm-arm64)
        uses: actions/upload-artifact@v4
        with:
          name: apt-${{ env.SUITE }}-${{ env.ARCH }}
          path: ${{ env.SUITE }}/
          if-no-files-found: error
          retention-days: 90


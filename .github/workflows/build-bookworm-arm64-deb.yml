name: Build gqrx (Qt6) + publish signed APT repo (bookworm/main, arm64)

on:
  push:
    branches: ["main"]
    tags: ["v*"]
  workflow_dispatch:

concurrency:
  group: pages
  cancel-in-progress: true

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-publish:
    runs-on: ubuntu-24.04-arm
    container: debian:bookworm

    env:
      SUITE: bookworm
      COMP: main
      ARCH: arm64
      PKGNAME: wolfberry-gqrx

      DEBIAN_FRONTEND: noninteractive
      DEB_BUILD_OPTIONS: nocheck
      DEBFULLNAME: wolfberry-gqrx
      DEBEMAIL: noreply@github.com

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install build deps (Qt6 + GNU Radio + SoapySDR from APT + packaging + repo tools)
        run: |
          apt-get update
          apt-get install -y --no-install-recommends \
            ca-certificates git \
            build-essential pkg-config \
            cmake ninja-build \
            debhelper devscripts dpkg-dev fakeroot \
            gnupg apt-utils \
            qt6-base-dev qt6-base-dev-tools qt6-svg-dev \
            libxkbcommon-dev \
            gnuradio-dev \
            gr-osmosdr \
            libsoapysdr-dev soapysdr-tools soapysdr-module-all \
            libvolk2-dev \
            libpulse-dev

      - name: Compute CI version (POSIX-safe)
        run: |
          SHORT_SHA="$(printf '%s' "$GITHUB_SHA" | cut -c1-7)"
          VERSION="$(date -u +%Y%m%d%H%M)-g${SHORT_SHA}"
          echo "VERSION=$VERSION" >> "$GITHUB_ENV"
          echo "CI Version: $VERSION"

      - name: Generate minimal debian/ packaging (if missing) with Qt6 forced
        run: |
          set -e
          if [ -d debian ] && [ -f debian/control ]; then
            echo "Found existing debian/ packaging. Will use it."
            exit 0
          fi

          echo "No debian/ packaging found -> generating minimal debian/ (Qt6 forced)."
          mkdir -p debian/source

          cat > debian/control <<EOF
          Source: ${PKGNAME}
          Section: hamradio
          Priority: optional
          Maintainer: ${DEBFULLNAME} <${DEBEMAIL}>
          Build-Depends:
           debhelper-compat (= 13),
           cmake,
           ninja-build,
           pkg-config,
           qt6-base-dev,
           qt6-svg-dev,
           libxkbcommon-dev,
           gnuradio-dev,
           gr-osmosdr,
           libsoapysdr-dev,
           libvolk2-dev,
           libpulse-dev
          Standards-Version: 4.6.2
          Rules-Requires-Root: no

          Package: ${PKGNAME}
          Architecture: ${ARCH}
          Depends: \${shlibs:Depends}, \${misc:Depends}
          Description: gqrx built with Qt6 (arm64, bookworm)
           Custom build of gqrx with Qt6 for Raspberry Pi OS (Bookworm).
          EOF

          cat > debian/rules <<'EOF'
          #!/usr/bin/make -f

          %:
          	dh $@ --buildsystem=cmake+ninja

          override_dh_auto_configure:
          	dh_auto_configure -- \
          	  -DCMAKE_BUILD_TYPE=Release \
          	  -DCMAKE_INSTALL_PREFIX=/usr \
          	  -DFORCE_QT6=ON \
          	  -DFORCE_QT5=OFF \
          	  -DLINUX_AUDIO_BACKEND=Pulseaudio
          EOF
          chmod +x debian/rules

          echo "3.0 (native)" > debian/source/format

          cat > debian/changelog <<EOF
          ${PKGNAME} (0.0.0) ${SUITE}; urgency=medium

            * Initial CI package.

           -- ${DEBFULLNAME} <${DEBEMAIL}>  $(date -u -R)
          EOF

      - name: Set debian/changelog version (CI)
        run: |
          dch --distribution "$SUITE" --newversion "$VERSION" "CI build" || true
          head -n 5 debian/changelog

      - name: Build .deb
        run: |
          set -e
          dpkg-buildpackage -b -us -uc -j"$(nproc)"
          mkdir -p out
          cp -v ../${PKGNAME}_*_${ARCH}.deb out/
          ls -la out

      - name: Import signing key (base64)
        env:
          APT_GPG_PRIVATE_KEY_B64: ${{ secrets.APT_GPG_PRIVATE_KEY_B64 }}
        run: |
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg

          if [ -z "$APT_GPG_PRIVATE_KEY_B64" ]; then
            echo "ERROR: Secret APT_GPG_PRIVATE_KEY_B64 is empty/missing."
            exit 1
          fi

          printf '%s' "$APT_GPG_PRIVATE_KEY_B64" | base64 -d | gpg --batch --import
          KEYID="$(gpg --list-secret-keys --with-colons | awk -F: '/^sec/{print $5; exit}')"
          if [ -z "$KEYID" ]; then
            echo "ERROR: No secret key imported."
            exit 1
          fi
          echo "SIGNING_KEYID=$KEYID" >> "$GITHUB_ENV"
          gpg --list-secret-keys --keyid-format=long

      - name: Build signed APT repo (dists/bookworm/main/...) for Pages
        env:
          APT_GPG_PASSPHRASE: ${{ secrets.APT_GPG_PASSPHRASE }}
        run: |
          set -e

          rm -rf public
          mkdir -p "public/pool/${COMP}"
          mkdir -p "public/dists/${SUITE}/${COMP}/binary-${ARCH}"

          # 1) .deb в pool
          cp -v out/*.deb "public/pool/${COMP}/"

          # 2) (по желание) публикувай публичния ключ за клиентите
          # Файлът repo-key.asc трябва да е commit-нат в репото (публичен ключ)
          if [ -f repo-key.asc ]; then
            cp -v repo-key.asc public/repo-key.asc
          fi

          # 3) Packages + Packages.gz
          cd public
          dpkg-scanpackages -m "pool/${COMP}" /dev/null > "dists/${SUITE}/${COMP}/binary-${ARCH}/Packages"
          gzip -9fk "dists/${SUITE}/${COMP}/binary-${ARCH}/Packages"

          # 4) Release за suite
          cat > apt-ftparchive.conf <<EOF
          APT::FTPArchive::Release::Origin "Wolfberry";
          APT::FTPArchive::Release::Label "Wolfberry APT";
          APT::FTPArchive::Release::Suite "${SUITE}";
          APT::FTPArchive::Release::Codename "${SUITE}";
          APT::FTPArchive::Release::Architectures "${ARCH}";
          APT::FTPArchive::Release::Components "${COMP}";
          APT::FTPArchive::Release::Description "Wolfberry gqrx repo";
          EOF

          apt-ftparchive -c apt-ftparchive.conf release "dists/${SUITE}" > "dists/${SUITE}/Release"

          # 5) Подписи: InRelease + Release.gpg
          gpg --batch --yes --pinentry-mode loopback \
            --passphrase "$APT_GPG_PASSPHRASE" \
            --default-key "$SIGNING_KEYID" \
            --digest-algo SHA256 \
            --clearsign -o "dists/${SUITE}/InRelease" "dists/${SUITE}/Release"

          gpg --batch --yes --pinentry-mode loopback \
            --passphrase "$APT_GPG_PASSPHRASE" \
            --default-key "$SIGNING_KEYID" \
            --digest-algo SHA256 \
            -abs -o "dists/${SUITE}/Release.gpg" "dists/${SUITE}/Release"

      - name: Configure Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
        
